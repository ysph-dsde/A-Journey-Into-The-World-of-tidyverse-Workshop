<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Worked Through Example</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Worked Through Example_files/libs/clipboard/clipboard.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/quarto.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/popper.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/anchor.min.js"></script>
<link href="Worked Through Example_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Worked Through Example_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Worked Through Example_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Worked Through Example_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Worked Through Example_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="Worked Through Example_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="Worked Through Example_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="Worked Through Example_files/libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="Worked Through Example_files/libs/typedarray-0.1/typedarray.min.js"></script>
<script src="Worked Through Example_files/libs/jquery-3.5.1/jquery.min.js"></script>
<link href="Worked Through Example_files/libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="Worked Through Example_files/libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="Worked Through Example_files/libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="Worked Through Example_files/libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Worked Through Example</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shelby Golden, M.S. and Howard Baik, M.S. </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this workshop, we will explore the <strong>tidyverse</strong> collection of R packages to clean, analyze, and visualize COVID-19 daily death counts in the United States. Additionally, we will make our visualizations interactive using the <code>plotly</code> package.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>First, we will load the necessary libraries and any special functions used in the script.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)      <span class="co"># For reading in the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)      <span class="co"># For tidying data </span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)      <span class="co"># For data manipulation </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)    <span class="co"># For string manipulation</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)  <span class="co"># For date manipulation</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)    <span class="co"># For creating static visualizations</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)     <span class="co"># For interactive plots</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)     <span class="co"># For formatting plots axis</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to select "Not In"</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">'%!in%'</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y)<span class="sc">!</span>(<span class="st">'%in%'</span>(x,y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will fetch the semi-cleaned COVID-19 deaths data set that has been prepared for this example. The original, raw data comes from the Johns Hopkins University Coronavirus Resource Center (JHU CRC) Center for Systems Science and Engineering (CSSE) GitHub page: CSSEGISandData. The full data cleaning script and links to the original raw data set can be found in the GitHub page for this workshop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the GitHub raw URL associated with our data set.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df_url  <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/ysph-dsde/A-Journey-Into-The-World-of-tidyverse-Workshop/refs/heads/main/Data%20for%20the%20Workshop_Aggregated%20by%20Month.csv"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data set using the URL via the readr package.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>df_raw  <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> df_url, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s good practice to review aspects of your raw data before proceeding with cleaning it. This includes:<br>
- Reviewing the variable data dictionary.<br>
- Looking at the dimensions of the data set.<br>
- Looking at the first and/or last few rows.<br>
- Looking at the variable classification for each column of information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a look at the first few rows and columns of the raw data.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 43
  Combined_Key    County Province_State Country_Region `2020-01-01` `2020-02-01`
  &lt;chr&gt;           &lt;chr&gt;  &lt;chr&gt;          &lt;chr&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
1 Alabama, US     &lt;NA&gt;   Alabama        US                        0            0
2 Alaska, US      &lt;NA&gt;   Alaska         US                        0            0
3 American Samoa… &lt;NA&gt;   American Samoa US                        0            0
4 Arizona, US     &lt;NA&gt;   Arizona        US                        0            0
5 Arkansas, US    &lt;NA&gt;   Arkansas       US                        0            0
6 California, US  &lt;NA&gt;   California     US                        0            0
# ℹ 37 more variables: `2020-03-01` &lt;dbl&gt;, `2020-04-01` &lt;dbl&gt;,
#   `2020-05-01` &lt;dbl&gt;, `2020-06-01` &lt;dbl&gt;, `2020-07-01` &lt;dbl&gt;,
#   `2020-08-01` &lt;dbl&gt;, `2020-09-01` &lt;dbl&gt;, `2020-10-01` &lt;dbl&gt;,
#   `2020-11-01` &lt;dbl&gt;, `2020-12-01` &lt;dbl&gt;, `2021-01-01` &lt;dbl&gt;,
#   `2021-02-01` &lt;dbl&gt;, `2021-03-01` &lt;dbl&gt;, `2021-04-01` &lt;dbl&gt;,
#   `2021-05-01` &lt;dbl&gt;, `2021-06-01` &lt;dbl&gt;, `2021-07-01` &lt;dbl&gt;,
#   `2021-08-01` &lt;dbl&gt;, `2021-09-01` &lt;dbl&gt;, `2021-10-01` &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>We see that the data set has 3394 unique regions in the U.S. at the county- and state-level with 43 columns of information. The first four columns denotes the region in different formats, and the remaining 39 columns represent the date when COVID-19 deaths were added to the running tally. All counts are reported as cumulative (monotonically increasing), and have been summarized to monthly updates.</p>
<p>In following sections we will continue reviewing aspects of our data set, including confirming the variable classes are correct. Before we continue, we need to tidy our data, which is done in the next section.</p>
</section>
<section id="data-tidying-using-tidyr" class="level2">
<h2 class="anchored" data-anchor-id="data-tidying-using-tidyr">Data tidying using tidyr</h2>
<p>As noted in the previous section, observations are added as new columns, creating what is referred to as a wide data set. To render the raw data into the target “tidy” format we need columns to only represent variables. This can be achieved by transforming the array of dates into new rows instead of columns, referred to as a long data set.</p>
<p><code>tidyr</code> provides us with a convenient function that will do such a transformation in one expression, <code>pivot_longer()</code>. In that function, we need to indicate which array of columns need to be transposed from columns to rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find which dates constitute the start and end of our array.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"Start date: "</span>, <span class="st">"End date: "</span>), <span class="fu">colnames</span>(df_raw)[<span class="fu">c</span>(<span class="dv">5</span>, <span class="fu">ncol</span>(df_raw))])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Start date: 2020-01-01" "End date: 2023-03-01"  </code></pre>
</div>
</div>
<p>Using the start and end column names of the dates array, we can pivot the raw data into a long-format.</p>
<p>Notice that we also need to provide the names of two new columns generated by this operation: one column to store the pivoted column names and one column to store the values previously expanded under those columns. Also notice that the colon in <code>"2020-01-01":"2023-03-01"</code> is prompting the function to use all consecutive columns between the first and last column name denoted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_long <span class="ot">&lt;-</span> df_raw <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Convert wide-format date columns to long-format.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Designate which columns need to be pivoted.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="st">"2020-01-01"</span><span class="sc">:</span><span class="st">"2023-03-01"</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Name the variable that will store newly pivoted column names.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Date"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Name the variable that will store respective cell values.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Deaths_Count_Cumulative"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Change table format to "data frame" class for convenience.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the pivoted data.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Combined_Key County Province_State Country_Region       Date
1  Alabama, US   &lt;NA&gt;        Alabama             US 2020-01-01
2  Alabama, US   &lt;NA&gt;        Alabama             US 2020-02-01
3  Alabama, US   &lt;NA&gt;        Alabama             US 2020-03-01
4  Alabama, US   &lt;NA&gt;        Alabama             US 2020-04-01
5  Alabama, US   &lt;NA&gt;        Alabama             US 2020-05-01
6  Alabama, US   &lt;NA&gt;        Alabama             US 2020-06-01
  Deaths_Count_Cumulative
1                       0
2                       0
3                      23
4                     272
5                     630
6                     950</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Number of rows: 132366" "Number of columns: 6"  </code></pre>
</div>
</div>
<p>This formatting looks quite a lot better. We see that each column represents its own variable, and each row represents a new observation over a range of dates for each county- and state-level region. Technically, our data set is now “tidy”, but might still require some additional preparations or cleaning.</p>
<p>In following sections we will continue reviewing and processing the data so that it is ready for visualization and statistical analyses.</p>
</section>
<section id="data-manipulation-using-dplyr" class="level2">
<h2 class="anchored" data-anchor-id="data-manipulation-using-dplyr">Data manipulation using dplyr</h2>
<p>Let’s say we want to plot deaths as a result of the COVID-19 pandemic for the whole U.S. We will need to generate these counts from the data set we have. This can be accomplished by summing cumulative deaths counts grouped by region (<code>Combined_Key</code>) and the month when new deaths were reported (<code>Date</code>). Cumulative counts are difficult to interpret, and so we will also want to back-calculate the monthly counts.</p>
<p><code>dplyr</code> provides us with a series of functions that allow us to do such data manipulation tasks. Over the next four code blocks, we will show how to generate counts for the whole U.S.</p>
<section id="calculate-total-u.s.-counts" class="level3">
<h3 class="anchored" data-anchor-id="calculate-total-u.s.-counts">Calculate total U.S. counts</h3>
<p>Recall that the imported data set includes values for U.S. counties, states, and territories. We need to calculate U.S. values over the U.S. states, including the District of Columbia, only. This can be achieved by first filtering for <code>Combined_Key</code> entries that match those state names using <code>filter()</code>.</p>
<p>Notice that we are using a <code>stringr</code> function, <code>str_c()</code> or string concatenate, to create a vector of names that can be matched with entries in <code>Combined_Key</code>. This function will be discussed in the next section covering <code>stringr</code>.</p>
<p><strong>Step 1:</strong> Filter subsets the data set by rows that match the condition.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="ot">&lt;-</span> df_long <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Combined_Key <span class="sc">%in%</span> <span class="fu">str_c</span>(<span class="fu">c</span>(datasets<span class="sc">::</span>state.name, <span class="st">"District of Columbia"</span>), <span class="st">", US"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The full data set has 132366 rows and after filtering we only have 1989 remaining. These each represent the observations for all U.S. states, including the District of Columbia which was reported separately. Recall that there were 39 months within the span of the pandemic where observations were recorded, meaning we have 132366/39 = 51 unique regions reported.</p>
<p>Using this filtered data set, we will want to group row entries by unique months. We accomplish that using <code>group_by()</code>. In the table that follows this grouping, we show how many rows are being grouped with each unique month using <code>tally()</code>.</p>
<p><strong>Step 2:</strong> Groups the table by unique entries in <code>Date</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> df_filtered <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the number of entries associated with each group using tally().</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="sc">|&gt;</span> <span class="fu">tally</span>() <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  Date           n
  &lt;chr&gt;      &lt;int&gt;
1 2020-01-01    51
2 2020-02-01    51
3 2020-03-01    51
4 2020-04-01    51
5 2020-05-01    51
6 2020-06-01    51</code></pre>
</div>
</div>
<p>As expected, we have 51 row entries that are being grouped by each month recorded. Now we are ready to calculate the total U.S. counts. The function <code>summarize()</code> allows us to iterate a function over each grouping. If necessary, the function can be prompted to retain previously designated groups using <code>.groups = "keep"</code>.</p>
<p><strong>Step 3:</strong> Calculate the cumulative deaths variable for the U.S. by summing over the grouped rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_US <span class="ot">&lt;-</span> df_grouped <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Deaths_Count_Cumulative =</span> <span class="fu">sum</span>(Deaths_Count_Cumulative), <span class="at">.groups =</span> <span class="st">"keep"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we need to remove the groupings so we can work with the whole data set again.</p>
<p><strong>Step 4:</strong> Remove grouping to work with the full data frame again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_US <span class="ot">&lt;-</span> df_US <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After these four operations, we get the following data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_US)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  Date       Deaths_Count_Cumulative
  &lt;chr&gt;                        &lt;dbl&gt;
1 2020-01-01                       1
2 2020-02-01                       2
3 2020-03-01                    5335
4 2020-04-01                   66500
5 2020-05-01                  107705
6 2020-06-01                  127302</code></pre>
</div>
</div>
<p>Now we are ready to merge this back with the main data frame. <code>bind_rows()</code> is a tidyverse function that is similar to <code>do.call()</code>, but it will also fill missing columns with <code>NA</code> so that the maximum number of uniquely defined variables are maintained.</p>
<p>Right now, the data frame <code>df_US</code> is missing the <code>Combined_Key</code> column. If we use <code>bind_rows()</code> at this stage, then <code>Combined_Key</code> for all U.S. rows will be <code>NA</code>. Instead, we want to add a new <code>Combined_Key</code> that says <code>"US"</code>. This is achieved using <code>mutate()</code>, which generates a new column using a functions of existing columns or static operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_US <span class="ot">&lt;-</span> df_US <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Combined_Key =</span> <span class="st">"US"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the mutated data.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_US)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  Date       Deaths_Count_Cumulative Combined_Key
  &lt;chr&gt;                        &lt;dbl&gt; &lt;chr&gt;       
1 2020-01-01                       1 US          
2 2020-02-01                       2 US          
3 2020-03-01                    5335 US          
4 2020-04-01                   66500 US          
5 2020-05-01                  107705 US          
6 2020-06-01                  127302 US          </code></pre>
</div>
</div>
<p>Great, now that we have all the columns we need, we are ready to merge it with <code>df_long</code>, which contains all of the county- and state-level data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_US, df_long) <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change table format to "data frame" class for convenience.</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the merged data.</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Deaths_Count_Cumulative Combined_Key County Province_State
1 2020-01-01                       1           US   &lt;NA&gt;           &lt;NA&gt;
2 2020-02-01                       2           US   &lt;NA&gt;           &lt;NA&gt;
3 2020-03-01                    5335           US   &lt;NA&gt;           &lt;NA&gt;
4 2020-04-01                   66500           US   &lt;NA&gt;           &lt;NA&gt;
5 2020-05-01                  107705           US   &lt;NA&gt;           &lt;NA&gt;
6 2020-06-01                  127302           US   &lt;NA&gt;           &lt;NA&gt;
  Country_Region
1           &lt;NA&gt;
2           &lt;NA&gt;
3           &lt;NA&gt;
4           &lt;NA&gt;
5           &lt;NA&gt;
6           &lt;NA&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Date Deaths_Count_Cumulative       Combined_Key County
132400 2022-10-01                       3 Grand Princess, US   &lt;NA&gt;
132401 2022-11-01                       3 Grand Princess, US   &lt;NA&gt;
132402 2022-12-01                       3 Grand Princess, US   &lt;NA&gt;
132403 2023-01-01                       3 Grand Princess, US   &lt;NA&gt;
132404 2023-02-01                       3 Grand Princess, US   &lt;NA&gt;
132405 2023-03-01                       3 Grand Princess, US   &lt;NA&gt;
       Province_State Country_Region
132400 Grand Princess             US
132401 Grand Princess             US
132402 Grand Princess             US
132403 Grand Princess             US
132404 Grand Princess             US
132405 Grand Princess             US</code></pre>
</div>
</div>
<p>The <code>select()</code> function is used to keep or drop columns. It can also be used to organize the existing columns. We would like to organize the columns by region followed by the month the record was made and then the cumulative deaths recorded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate new columns using mutate.</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Combined_Key, County, Province_State, Country_Region, Date, Deaths_Count_Cumulative)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the merged data.</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Combined_Key County Province_State Country_Region       Date
1           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-01-01
2           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-02-01
3           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-03-01
4           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-04-01
5           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-05-01
6           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-06-01
  Deaths_Count_Cumulative
1                       1
2                       2
3                    5335
4                   66500
5                  107705
6                  127302</code></pre>
</div>
</div>
</section>
<section id="backcalculate-monthly-updates" class="level3">
<h3 class="anchored" data-anchor-id="backcalculate-monthly-updates">Backcalculate monthly updates</h3>
<p>Now we are ready to calculate the monthly death counts from the cumulative counts. Earlier we implied that <code>mutate()</code> can be used to generate new columns that are functions of existing columns. Here, we generate a new vector using <code>diff()</code> to back-calculated values added each month.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily monthly deaths counts using mutate.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span>  </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Deaths_Count_Monthly =</span> <span class="fu">c</span>(Deaths_Count_Cumulative[<span class="dv">1</span>], <span class="fu">diff</span>(Deaths_Count_Cumulative)))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the wrangled data set.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Combined_Key County Province_State Country_Region       Date
1           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-01-01
2           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-02-01
3           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-03-01
4           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-04-01
5           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-05-01
6           US   &lt;NA&gt;           &lt;NA&gt;           &lt;NA&gt; 2020-06-01
  Deaths_Count_Cumulative Deaths_Count_Monthly
1                       1                    1
2                       2                    1
3                    5335                 5333
4                   66500                61165
5                  107705                41205
6                  127302                19597</code></pre>
</div>
</div>
<p>As a last step, we will inspect the classifications for each variable and ensure that they are correctly classified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(df, class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Combined_Key                  County          Province_State 
            "character"             "character"             "character" 
         Country_Region                    Date Deaths_Count_Cumulative 
            "character"             "character"               "numeric" 
   Deaths_Count_Monthly 
              "numeric" </code></pre>
</div>
</div>
<p>Currently, <code>Date</code> is classified as a character. We can change the class to date using the lubridate package from tidyverse. This package is not covered in this introductory workshop, but those interested to find out more can review the package documentation: https://lubridate.tidyverse.org/</p>
<p>Notice that the data has been reported in yyyy/mm/dd format. Therefore, we use <code>ymd()</code> to correctly convert the character to the date class. We also format these to only report the year followed by the month abbreviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>Date <span class="ot">&lt;-</span> <span class="fu">ymd</span>(df<span class="sc">$</span>Date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="string-manipulation-using-stringr" class="level2">
<h2 class="anchored" data-anchor-id="string-manipulation-using-stringr">String manipulation using stringr</h2>
<p>After completing bulk data wrangling operations, like the ones completed above, it is good practice to examine variable classifications and nomenclature before any calculations. For example, if you have a variable for the sex of a participant, you will want to confirm that all entries of that variable say <code>"M"</code> and <code>"F"</code> for Male and Female, respectively. You might also need to confirm that zero’s are not being used in place of <code>NA</code> when the value is not determined.</p>
<p>In this scenario, we are going to assume that the county-level entries are correct. We expect that the U.S. states and territories are represented for state-level entries. We can examine other state-level entries by reporting the complement of matches to unique entries of <code>Combined_Key</code> to <code>datasets::state.name</code> and the District of Columbia.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the non-states represented in the state-level data set.</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>Province_State)[<span class="fu">unique</span>(df<span class="sc">$</span>Province_State) <span class="sc">%!in%</span> <span class="fu">c</span>(datasets<span class="sc">::</span>state.name, <span class="st">"District of Columbia"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA                         "American Samoa"          
[3] "Guam"                     "Northern Mariana Islands"
[5] "Puerto Rico"              "Virgin Islands"          
[7] "Diamond Princess"         "Grand Princess"          </code></pre>
</div>
</div>
<p>Notice that there are <code>NA</code> detected. This should be correct, since the country-level counts are <code>NA</code> at the state-level. We can confirm this by showing all <code>Combined_Key</code> entries are “US” for rows with <code>"Province_State" = NA</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df[df<span class="sc">$</span>Province_State <span class="sc">%in%</span> <span class="cn">NA</span>, <span class="st">"Combined_Key"</span>] <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "US"</code></pre>
</div>
</div>
<p>In addition to the five U.S. territories, there are entries for two cruise ships. These are not relevant to our analysis, and so we exclude them using <code>str_detect()</code> or <code>str_which()</code>. Both of these functions will find the rows where a string pattern is matched, and report the findings as either a Boolean (<code>TRUE</code>/<code>FALSE</code>) or row-index.</p>
<p><strong>Option #1:</strong> Use the Boolean test that detects the <code>"Princess"</code> string. Note that the added <code>%in% TRUE</code> is used to address NA outcomes that need to be interpreted as <code>FALSE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="ot">&lt;-</span> df[<span class="sc">!</span><span class="fu">str_detect</span>(df<span class="sc">$</span>Province_State, <span class="st">"Princess"</span>) <span class="sc">%in%</span> <span class="cn">TRUE</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Option #2:</strong> Find the index that detects the “Princess” string and use the indexes that do not contain that string to subset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="ot">&lt;-</span> df[<span class="sc">-</span><span class="fu">str_which</span>(df<span class="sc">$</span>Province_State, <span class="st">"Princess"</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice one could use <code>str_which(df$Combined_Key, "Princess", negate = TRUE)</code>. However, because there are <code>NA</code> in the “Combined_Key” vector the version displayed above needs to be used to maintain those rows.</p>
<p>Doing this removes the following number of rows from the larger data set; this translates to two unique regions with 39 dates associated with each, as expected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(df) <span class="sc">-</span> <span class="fu">nrow</span>(df_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 78</code></pre>
</div>
</div>
<p>The <code>Combined_Key</code> variable combines information from <code>County</code>, <code>Province_State</code>, and <code>Country_Region</code>. Assume we only have the county-level data and wish to generate the state- and country-level <code>Combined_Key</code> variable. We can do this in two ways: <code>str_c()</code> or <code>str_split()</code>.</p>
<p>For this example we will subset the data by county-level information only. We use <code>str_count()</code> to represent the number of times a string pattern is detected within any given string. County-level data will have two commas, so this is one method we can use to subset our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_county <span class="ot">&lt;-</span> df_filtered[<span class="fu">str_count</span>(df_filtered<span class="sc">$</span>Combined_Key, <span class="st">","</span>) <span class="sc">==</span> <span class="dv">2</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Option #1:</strong> Generate a new column by combining the desired columns with <code>", "</code> as the separator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(df_county<span class="sc">$</span>Province_State, df_county<span class="sc">$</span>Country_Region, <span class="at">sep =</span> <span class="st">", "</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "South Carolina, US"       "Louisiana, US"           
 [3] "Virginia, US"             "Idaho, US"               
 [5] "Iowa, US"                 "Kentucky, US"            
 [7] "Missouri, US"             "Oklahoma, US"            
 [9] "Colorado, US"             "Illinois, US"            
[11] "Indiana, US"              "Mississippi, US"         
[13] "Nebraska, US"             "North Dakota, US"        
[15] "Ohio, US"                 "Pennsylvania, US"        
[17] "Washington, US"           "Wisconsin, US"           
[19] "Vermont, US"              "Puerto Rico, US"         
[21] "Minnesota, US"            "Florida, US"             
[23] "North Carolina, US"       "California, US"          
[25] "New York, US"             "Wyoming, US"             
[27] "Michigan, US"             "Alaska, US"              
[29] "Maryland, US"             "Kansas, US"              
[31] "Tennessee, US"            "Texas, US"               
[33] "Maine, US"                "Arizona, US"             
[35] "Georgia, US"              "Arkansas, US"            
[37] "New Jersey, US"           "South Dakota, US"        
[39] "Alabama, US"              "Oregon, US"              
[41] "West Virginia, US"        "Massachusetts, US"       
[43] "Utah, US"                 "Montana, US"             
[45] "New Hampshire, US"        "New Mexico, US"          
[47] "Rhode Island, US"         "Nevada, US"              
[49] "District of Columbia, US" "Connecticut, US"         
[51] "Hawaii, US"               "Delaware, US"            </code></pre>
</div>
</div>
<p><strong>Option #2:</strong> Split the string only to the first observation of the string match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(df_county<span class="sc">$</span>Combined_Key, <span class="st">","</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>, <span class="at">n =</span> <span class="dv">2</span>)[, <span class="dv">2</span>] <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_trim</span>(<span class="at">side =</span> <span class="st">"both"</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "South Carolina, US"       "Louisiana, US"           
 [3] "Virginia, US"             "Idaho, US"               
 [5] "Iowa, US"                 "Kentucky, US"            
 [7] "Missouri, US"             "Oklahoma, US"            
 [9] "Colorado, US"             "Illinois, US"            
[11] "Indiana, US"              "Mississippi, US"         
[13] "Nebraska, US"             "North Dakota, US"        
[15] "Ohio, US"                 "Pennsylvania, US"        
[17] "Washington, US"           "Wisconsin, US"           
[19] "Vermont, US"              "Puerto Rico, US"         
[21] "Minnesota, US"            "Florida, US"             
[23] "North Carolina, US"       "California, US"          
[25] "New York, US"             "Wyoming, US"             
[27] "Michigan, US"             "Alaska, US"              
[29] "Maryland, US"             "Kansas, US"              
[31] "Tennessee, US"            "Texas, US"               
[33] "Maine, US"                "Arizona, US"             
[35] "Georgia, US"              "Arkansas, US"            
[37] "New Jersey, US"           "South Dakota, US"        
[39] "Alabama, US"              "Oregon, US"              
[41] "West Virginia, US"        "Massachusetts, US"       
[43] "Utah, US"                 "Montana, US"             
[45] "New Hampshire, US"        "New Mexico, US"          
[47] "Rhode Island, US"         "Nevada, US"              
[49] "District of Columbia, US" "Connecticut, US"         
[51] "Hawaii, US"               "Delaware, US"            </code></pre>
</div>
</div>
<p>Say we wish to specify that the Virgin Islands entries only reflect results for the U.S. territory. We can replace specific strings exactly using <code>str_replace()</code>.</p>
<p>Going forward, we only require the <code>Combined_Key</code> variable, as the <code>Country_Region</code>, <code>Province_State</code>, and <code>County</code> variables are succinctly represented there. We can adjust the <code>"Virgin Islands"</code> entries for that column only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_filtered[, <span class="st">"Combined_Key"</span>] <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(df_filtered[, <span class="st">"Combined_Key"</span>],  <span class="st">"Virgin Islands"</span>, <span class="st">"US Virgin Islands"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="bonus-iterating-operations-over-columns" class="level3">
<h3 class="anchored" data-anchor-id="bonus-iterating-operations-over-columns">Bonus: iterating operations over columns</h3>
<p>Note that it is possible to adjust multiple columns at once using <code>sapply()</code>. Notice that with the base pipe <code>|&gt;</code> the standard placeholder <code>_</code> does not move information into the <code>sapply()</code> function. To fix this, we wrap the <code>sapply()</code> pipe level and specify a placeholder for the values being passed from the left-side to <code>sapply()</code>. In this scenario, we are calling that information <code>x</code>.</p>
<p><code>sapply()</code> is one of a few useful functions that repeats operations over columns, rows, or lists. <code>sapply()</code> will only apply the function over a the columns of a data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the row indices where "Virgin Islands" is detected in "Province_State".</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>index <span class="ot">=</span> <span class="fu">str_which</span>(df_filtered[, <span class="fu">c</span>(<span class="st">"Province_State"</span>)], <span class="st">"Virgin Islands"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>df_filtered[index, <span class="fu">c</span>(<span class="st">"Province_State"</span>, <span class="st">"Combined_Key"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the wrapper of this pipe-level and specify the information from</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the left to be "x".</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  (\(x) {</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the str_replace() function over "Province_State" and "Combined_Key".</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Notice that the added "^ " is a regex statement that defines a hard</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># boundary on the string.</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(x, <span class="cf">function</span>(y) <span class="fu">str_replace</span>(y,  <span class="st">"^Virgin Islands"</span>, <span class="st">"US Virgin Islands"</span>))</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  }) () <span class="sc">|&gt;</span> </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show that the changes have been completed.</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  _[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Province_State      Combined_Key           
 [1,] "US Virgin Islands" "US Virgin Islands, US"
 [2,] "US Virgin Islands" "US Virgin Islands, US"
 [3,] "US Virgin Islands" "US Virgin Islands, US"
 [4,] "US Virgin Islands" "US Virgin Islands, US"
 [5,] "US Virgin Islands" "US Virgin Islands, US"
 [6,] "US Virgin Islands" "US Virgin Islands, US"
 [7,] "US Virgin Islands" "US Virgin Islands, US"
 [8,] "US Virgin Islands" "US Virgin Islands, US"
 [9,] "US Virgin Islands" "US Virgin Islands, US"
[10,] "US Virgin Islands" "US Virgin Islands, US"
[11,] "US Virgin Islands" "US Virgin Islands, US"
[12,] "US Virgin Islands" "US Virgin Islands, US"
[13,] "US Virgin Islands" "US Virgin Islands, US"
[14,] "US Virgin Islands" "US Virgin Islands, US"
[15,] "US Virgin Islands" "US Virgin Islands, US"</code></pre>
</div>
</div>
</section>
</section>
<section id="visualization-daily-covid-19-death-counts" class="level2">
<h2 class="anchored" data-anchor-id="visualization-daily-covid-19-death-counts">Visualization: Daily COVID-19 Death Counts</h2>
<p>We will calculate the daily COVID-19 death counts across the U.S. and create a line plot showing the daily COVID-19 death counts in the U.S.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot_deaths <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Combined_Key <span class="sc">==</span> <span class="st">"US"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename column names so they look nicer in plotly</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Date =</span> Date, <span class="at">Count =</span> Deaths_Count_Monthly) <span class="sc">|&gt;</span>  </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> Count)) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> Count), <span class="at">color =</span> <span class="st">"#880808"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format the y-axis to show values in terms of thousands.</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">unit_format</span>(<span class="at">unit =</span> <span class="st">"K"</span>, <span class="at">scale =</span> <span class="fl">1e-3</span>)) <span class="sc">+</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format the x-axis to show dates as Jan 2020 from 01/01/2020, spaced</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># every four months.</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"4 month"</span>, <span class="at">date_labels =</span>  <span class="st">"%b %Y"</span>) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Daily Counts"</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Daily Death Counts of COVID-19 in the US"</span>) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make plot interactive</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(plot_deaths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-a4ea540aef269173d75a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-a4ea540aef269173d75a">{"x":{"data":[{"x":[18262,18293,18322,18353,18383,18414,18444,18475,18506,18536,18567,18597,18628,18659,18687,18718,18748,18779,18809,18840,18871,18901,18932,18962,18993,19024,19052,19083,19113,19144,19174,19205,19236,19266,19297,19327,19358,19389,19417],"y":[1,1,5333,61165,41205,19597,26303,28877,22775,24336,39730,79628,95664,65102,36349,23677,17846,10373,8765,27955,58785,47860,34474,45987,62846,60978,32820,12895,10773,10726,11908,15920,13073,10755,10091,12036,15759,11160,3857],"text":["Date: 2020-01-01<br />Count:     1","Date: 2020-02-01<br />Count:     1","Date: 2020-03-01<br />Count:  5333","Date: 2020-04-01<br />Count: 61165","Date: 2020-05-01<br />Count: 41205","Date: 2020-06-01<br />Count: 19597","Date: 2020-07-01<br />Count: 26303","Date: 2020-08-01<br />Count: 28877","Date: 2020-09-01<br />Count: 22775","Date: 2020-10-01<br />Count: 24336","Date: 2020-11-01<br />Count: 39730","Date: 2020-12-01<br />Count: 79628","Date: 2021-01-01<br />Count: 95664","Date: 2021-02-01<br />Count: 65102","Date: 2021-03-01<br />Count: 36349","Date: 2021-04-01<br />Count: 23677","Date: 2021-05-01<br />Count: 17846","Date: 2021-06-01<br />Count: 10373","Date: 2021-07-01<br />Count:  8765","Date: 2021-08-01<br />Count: 27955","Date: 2021-09-01<br />Count: 58785","Date: 2021-10-01<br />Count: 47860","Date: 2021-11-01<br />Count: 34474","Date: 2021-12-01<br />Count: 45987","Date: 2022-01-01<br />Count: 62846","Date: 2022-02-01<br />Count: 60978","Date: 2022-03-01<br />Count: 32820","Date: 2022-04-01<br />Count: 12895","Date: 2022-05-01<br />Count: 10773","Date: 2022-06-01<br />Count: 10726","Date: 2022-07-01<br />Count: 11908","Date: 2022-08-01<br />Count: 15920","Date: 2022-09-01<br />Count: 13073","Date: 2022-10-01<br />Count: 10755","Date: 2022-11-01<br />Count: 10091","Date: 2022-12-01<br />Count: 12036","Date: 2023-01-01<br />Count: 15759","Date: 2023-02-01<br />Count: 11160","Date: 2023-03-01<br />Count:  3857"],"type":"scatter","mode":"lines","line":{"width":3.7795275590551185,"color":"rgba(136,8,8,1)","dash":"solid"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":43.762557077625573,"r":7.3059360730593621,"b":25.57077625570777,"l":54.794520547945211},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"Daily Death Counts of COVID-19 in the US","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[18204.25,19474.75],"tickmode":"array","ticktext":["Mar 2020","Jul 2020","Nov 2020","Mar 2021","Jul 2021","Nov 2021","Mar 2022","Jul 2022","Nov 2022","Mar 2023"],"tickvals":[18322,18444,18567,18687,18809,18932,19052,19174,19297,19417],"categoryorder":"array","categoryarray":["Mar 2020","Jul 2020","Nov 2020","Mar 2021","Jul 2021","Nov 2021","Mar 2022","Jul 2022","Nov 2022","Mar 2023"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-4782.1500000000005,100447.14999999999],"tickmode":"array","ticktext":["0 K","25 K","50 K","75 K","100 K"],"tickvals":[0,25000.000000000004,50000,75000,100000],"categoryorder":"array","categoryarray":["0 K","25 K","50 K","75 K","100 K"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":{"text":"Daily Counts","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"8fde456e77c3":{"x":{},"y":{},"type":"scatter"}},"cur_data":"8fde456e77c3","visdat":{"8fde456e77c3":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="challenge-questions" class="level2">
<h2 class="anchored" data-anchor-id="challenge-questions">Challenge Questions</h2>
<ol type="1">
<li>Filter the <code>df</code> data set to include only rows from 2021.</li>
<li>With the data set filtered for rows from 2021, determine the day with the highest death count along with the corresponding count.</li>
</ol>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>